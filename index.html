<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>Hand Demo – Camera Lock v2</title>

<script src="https://cdn.babylonjs.com/babylon.js"></script>
<script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>

<style>
html, body {
  margin:0; padding:0; width:100%; height:100%;
  overflow:hidden; background:#000;
}
#wrap { position:relative; width:100vw; height:100vh; }
#video, #snapshot {
  position:absolute; inset:0;
  width:100%; height:100%;
  object-fit:cover;
}
#snapshot { display:none; }
#renderCanvas {
  position:absolute; inset:0;
  width:100%; height:100%;
  pointer-events:none;
}
#ui {
  position:fixed;
  left:8px; right:8px; bottom:10px;
  display:flex; justify-content:space-between;
  z-index:10;
}
button {
  padding:10px 14px;
  font-size:14px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,0.3);
  background:rgba(0,0,0,0.6);
  color:#fff;
}
</style>
</head>

<body>
<div id="wrap">
  <video id="video" autoplay muted playsinline></video>
  <canvas id="snapshot"></canvas>
  <canvas id="renderCanvas"></canvas>

  <div id="ui">
    <div>
      <button id="btnCamera">Camera</button>
      <button id="btnLock">LOCK</button>
    </div>
    <div>
      <button id="btnMini">Mini Open</button>
      <button id="btnFit">Fit</button>
    </div>
  </div>
</div>

<script>
const GLB = "animetesthand2.glb";

let engine, scene, cam, anim;
let meshes = [];
let cameraOn = false;
let locked = false;

// ================= CAMERA =================
async function startCamera(){
  const video = document.getElementById("video");
  const snap = document.getElementById("snapshot");

  // リセット
  locked = false;
  snap.style.display = "none";
  video.style.display = "block";

  if(!cameraOn){
    const stream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:"environment" }, audio:false
    });
    video.srcObject = stream;
    await video.play();
    cameraOn = true;
  }

  setModePreview();
}

// 静止画取得
function freezeCamera(){
  const video = document.getElementById("video");
  const snap = document.getElementById("snapshot");
  snap.width = video.videoWidth;
  snap.height = video.videoHeight;
  snap.getContext("2d").drawImage(video,0,0);
  snap.style.display = "block";
  video.style.display = "none";
}

// ================= BABYLON =================
async function initBabylon(){
  if(engine) return;

  const canvas = document.getElementById("renderCanvas");
  engine = new BABYLON.Engine(canvas,true);
  scene = new BABYLON.Scene(engine);
  scene.clearColor = new BABYLON.Color4(0,0,0,0);

  cam = new BABYLON.ArcRotateCamera(
    "cam",
    Math.PI/2, Math.PI/2.2, 2.5,
    BABYLON.Vector3.Zero(), scene
  );

  new BABYLON.HemisphericLight("h",new BABYLON.Vector3(0,1,0),scene);

  const res = await BABYLON.SceneLoader.ImportMeshAsync(
    null,"./",GLB,scene
  );

  meshes = res.meshes.filter(m => m.name !== "__root__");
  anim = scene.animationGroups[0];
  anim.stop();

  engine.runRenderLoop(()=>scene.render());
}

// ================= MODES =================
function setModePreview(){
  if(!meshes.length) return;

  anim.stop();

  meshes.forEach(m=>{
    m.setEnabled(true);
    m.scaling.set(0.6,0.6,0.6);
    m.position.set(-0.9,-0.6,0);
  });

  cam.radius = 3.5;
  cam.target.set(-0.9,-0.6,0);

  anim.goToFrame(0);
  anim.pause();
}

function setModeLocked(){
  meshes.forEach(m=>{
    m.setEnabled(true);
    m.scaling.set(1.2,1.2,1.2);
    m.position.set(0,0,0);
  });

  cam.radius = 2.4;
  cam.target.set(0,0,0);
}

// ================= ANIMATION =================
function playLock(){
  if(!anim) return;
  anim.reset();
  anim.start(false,0.4,0,15,false);
}

function goFrame(f){
  if(!anim) return;
  anim.goToFrame(f);
  anim.pause();
}

// ================= UI =================
document.getElementById("btnCamera").onclick = startCamera;

document.getElementById("btnLock").onclick = async ()=>{
  await initBabylon();
  if(!locked){
    freezeCamera();
    setModeLocked();
    locked = true;
  }
  playLock();
};

document.getElementById("btnFit").onclick = ()=>goFrame(20);
document.getElementById("btnMini").onclick = ()=>goFrame(10);
</script>
</body>
</html>
