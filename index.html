<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>Camera + Duck Overlay (Safe Full Version)</title>

<script src="https://cdn.babylonjs.com/babylon.js"></script>
<script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>

<style>
html, body {
  margin:0; padding:0;
  width:100%; height:100%;
  overflow:hidden;
  background:#000;
}
#wrap {
  position:relative;
  width:100vw; height:100vh;
}
#video {
  position:absolute; inset:0;
  width:100%; height:100%;
  object-fit:cover;
  background:#000;
  z-index:0;
}
#renderCanvas {
  position:absolute; inset:0;
  width:100%; height:100%;
  z-index:1;
  touch-action:none;
}
#hudBar {
  position:fixed;
  left:8px; right:8px; bottom:10px;
  z-index:5;
  display:flex;
  justify-content:space-between;
  gap:10px;
}
.btn {
  padding:10px 12px;
  font-size:14px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,0.3);
  background:rgba(0,0,0,0.6);
  color:#fff;
}
#dbg {
  position:fixed;
  left:8px; top:8px; right:8px;
  z-index:6;
  max-height:45vh;
  overflow:auto;
  padding:10px;
  font:12px/1.4 monospace;
  color:#0f0;
  background:rgba(0,0,0,0.65);
  border-radius:10px;
  display:none;
  white-space:pre-wrap;
}
</style>
</head>

<body>
<div id="wrap">
  <video id="video" autoplay muted playsinline></video>
  <canvas id="renderCanvas"></canvas>

  <div id="dbg"></div>

  <div id="hudBar">
    <div>
      <button class="btn" id="btnCamera">Camera</button>
      <button class="btn" id="btnPlay">Play</button>
      <button class="btn" id="btnStop">Stop</button>
    </div>
    <div>
      <button class="btn" id="btnDebug">HUD</button>
    </div>
  </div>
</div>

<script>
/* ========= CONFIG ========= */
const GLB_NAME = "Duck1.glb";

/* ========= STATE ========= */
let engine, scene, camera;
let animGroups = [];
let duckLoaded = false;
let cameraReady = false;
let debugOn = false;

/* ========= LOG ========= */
const logBuf = [];
function log(msg){
  const line = `[${new Date().toISOString()}] ${msg}`;
  logBuf.push(line);
  if (logBuf.length > 200) logBuf.shift();
  console.log(line);
  if (debugOn) {
    document.getElementById("dbg").textContent = logBuf.join("\n");
  }
}

/* ========= CAMERA ========= */
async function startCamera(){
  if (cameraReady) return;
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:"environment" }, audio:false
    });
    const video = document.getElementById("video");
    video.srcObject = stream;
    await video.play();
    cameraReady = true;
    log("Camera started");
  } catch(e){
    alert("Camera failed");
  }
}

/* ========= BABYLON ========= */
function initBabylon(){
  if (engine) return;

  const canvas = document.getElementById("renderCanvas");
  engine = new BABYLON.Engine(canvas, true);
  scene  = new BABYLON.Scene(engine);

  /* ★ デバッグ中は必ず見える背景 */
  scene.clearColor = new BABYLON.Color4(0.2,0.2,0.2,1);

  camera = new BABYLON.ArcRotateCamera(
    "cam",
    Math.PI/2,
    Math.PI/2.2,
    8,
    BABYLON.Vector3.Zero(),
    scene
  );
  camera.minZ = 0.01;
  camera.maxZ = 1000;
  camera.attachControl(canvas, true);

  new BABYLON.HemisphericLight("l", new BABYLON.Vector3(0,1,0), scene);

  engine.runRenderLoop(()=> scene.render());
  window.addEventListener("resize", ()=> engine.resize());

  log("Babylon initialized");
}

/* ========= LOAD GLB ========= */
async function loadDuck(){
  if (duckLoaded) return;
  initBabylon();

  const res = await BABYLON.SceneLoader.ImportMeshAsync(
    null, "./", GLB_NAME, scene
  );

  animGroups = scene.animationGroups || [];
  duckLoaded = true;

  /* ★ スケールは小さめ＋カメラで調整 */
  scene.meshes.forEach(m=>{
    if (m.name !== "__root__") {
      m.scaling.set(3,3,3);
    }
  });

  log(`GLB loaded: meshes=${res.meshes.length}, anim=${animGroups.length}`);
}

/* ========= PLAY / STOP ========= */
async function playDuck(){
  if (!cameraReady){
    alert("Start Camera first");
    return;
  }
  await loadDuck();
  animGroups.forEach(g=> g.start(true));
  log("Play");
}
function stopDuck(){
  animGroups.forEach(g=> g.stop());
  log("Stop");
}

/* ========= UI ========= */
document.getElementById("btnCamera").onclick = startCamera;
document.getElementById("btnPlay").onclick   = playDuck;
document.getElementById("btnStop").onclick   = stopDuck;
document.getElementById("btnDebug").onclick  = ()=>{
  debugOn = !debugOn;
  document.getElementById("dbg").style.display = debugOn?"block":"none";
};
log("Boot ready");
</script>
</body>
</html>
